---
title: "Final Report"
author: "Team 6 purple"
date: "9/17/2020"
output: html_notebook
---

# PART II -- 

## Summary

## Introduction

Job training, in a long term, is considered an efficient way to leverage the income level of disadvantaged workers. In 1970s, several experiments was conducted to reveal the real impact of job training on participants' wages, including the National Supported Work (NSW) Demonstration[1]. In the experiment, eligible workers were assigned to receive job training and their incomes in 1973, 1974 and 1977 were recorded according.

The primary goal of this analysis is to access whether receiving a job training has a significant impact on the possibility of getting a paid job. Other considerations includes whether this effect differ by demographic groups in terms of age, education and racial identity. We're also interested to explore other association with positive wages.

**Data Processing**

The data used in this analysis was accessed via the NSW Demonstration experiment. The original data includes 614 non-empty observations. Since we only cares about the possibility of getting a paid job, we generated a new binary categorical variable 'inc78' where 0 represents zero wages and 1 for non-zero wages, and used it as our response variable. The cleaned dataset included 10 distinctive predictors -- 5 categorical ones and 4 numeric.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
knitr::opts_chunk$set(out.width = '50%')
knitr::opts_chunk$set(fig.align="center")
```

```{r library, message=FALSE}
library(tidyverse) # Data wrangling
library(ggplot2) # Plotting

# For logistic regression
library(arm)
library(car)
library(pROC)
library(e1071)
library(caret)

## table
library(knitr)
library(kableExtra)
```

```{r import data, echo=FALSE}
income = read.table("lalondedata.txt", header = T, sep = ",", dec = ".")
```

```{r data processing, echo=FALSE}
# Change the variable to factor levels
income = income %>% mutate(
        inc78 = case_when(
                re78 == 0 ~ 0,
                re78 > 0 ~ 1, )
        )

income$inc78_factor <- as.factor(income$inc78)
income$treat <- as.factor(income$treat)
income$black <- as.factor(income$black)
income$hispan <- as.factor(income$hispan)
income$married <- as.factor(income$married)
income$nodegree <- as.factor(income$nodegree)
```

## Exploratory Data Analysis

EDA is a process of uncovering useful information and pattern of the data set through statistical summary, table and visulization.

**Response_Variable**

In this analysis, a table of the response variables 'inc78_fator' is conducted to examine the sufficiency of observations for both level, and get a general understanding of the baseline probability for model fitting and further analysis. According to the table, we have 471 workers with positive wage and 143 unemployed. The average possibility of getting a non-zero wage job in 1978 is about 76% in the sample population.

```{r response varible, echo=FALSE}
table(income$inc78_factor)
```

**Treatment vs Non-zero Wage**

According to the table of conditional probabilities for having an non-zero income given whether the worker received a job training, the paid employment rate, in average, is slightly lower when the worker did. However, giving a chiq test score of 0.76, we suggest that there's no evidence showing differences in possibility of having positive (non-zero) wages between workers who recived the training and those who did not.

```{r, echo = FALSE}
apply(table(income[,c("inc78_factor","treat")])/sum(table(income[,c("inc78_factor","treat")])), 2, function(x) x/sum(x))
chisq.test(table(income[,c("inc78_factor","treat")])) ## CORRECT??
```

**Other Categorical Variables**

Looking at other categorical variable, there's a significant lower average conditional possibility of having non-zero wage when the worker's racial identity is Black, compared to those who not. The differences suggest an possible association between Black and our response variable that are worth exploring in our final model. Even though there's a obvious difference between non-Hispanic group and Hispanic group, the insights need to be reexamined later to avoid the effect of insufficient observations on Hispanic workers. 

Since no significant change in the possibilities cross different level is observed in 'married' and 'nondegree', they might be pool predictor for predicting the non-zero wage rate and their interaction effects will be tested later. 

```{r, echo = FALSE}
apply(table(income[,c("inc78_factor","black")])/sum(table(income[,c("inc78_factor","black")])),
      2,function(x) x/sum(x))

apply(table(income[,c("inc78_factor","hispan")])/sum(table(income[,c("inc78_factor","hispan")])),
      2,function(x) x/sum(x))
```

**Numeric Variables**

According to the boxplot analysis, the average and range of age in the group where people have non-zero wage is significant higher, compare to the group where people do not. Given a chi-square test of 0.002, we suggest an association between age and positive wage rate that the older the worker, the less chance to get an paid employment, keeping everything else the same.

```{r, echo = FALSE}
ggplot(income,aes(x = inc78_factor, y = age)) +
  geom_boxplot()
chisq.test(table(income[,c("inc78_factor","age")])) 
## ??? significant under 0.05 threshold but warning message, chi maybe incorrect
```

**Interaction Effect**

Interaction effects occur when the effect of one variable depends on the value of another variable. Conditional possibility tables and faceted boxplots are generated to test the interaction effect between terms. The visualized change in the association between non-zero wage and age given whether the participants received job training indicates a possible interaction effect between treatment and age. That is, job training reduce the disadvantage of older workers in terms of getting a paid role.

Anther interesting interaction happened between age and degree where the association between non-zero wage and age change significantly when shifting from groups with individuals having high school degree to groups without. The possibility of getting paid employment tends to stay the same and even increase as a worker with high school degree grows older, while the possibility decrease as one without high school degree

Both interaction terms should be added into our final model for further analysis.

```{r, echo = FALSE}
ggplot(data= income, aes(x=age, y=inc78_factor)) + geom_boxplot() + facet_wrap(~treat)

ggplot(data= income, aes(x=age, y=inc78_factor)) + geom_boxplot() + facet_wrap(~nodegree)
```

## Model Selection 

The model selection is based on two methods: AIC Stepwise Selection and anova chiq test. 

For this analysis, all potential predictor is fitted into a full model. Using stepwise selection, a combination of forward and backward selection, with a null model containing only treatment as predictor, variables are either added or removed in several stages in the process to meet the maximum likelihood estimation. At the end of process, two significant varibles -- age and black -- are selected. 

To explore the real effect of demographic groups on the association between non-zero wage and job training, interaction terms between treatment and other variables were added to the full model one by one and their efficiency is tested by an anova chi-q test. Given a p-value of 0.038 when we use anova to compare model with interactions between age and treatment vs without, we reject the hypothesis and confirmed the interaction term efficient for predicting the possibility of getting non-zero wage. Even though the interaction effect between age and high school degree seems significant in previous EDA, we failed to reject the null hypothesis and found the interaction term negligible. 

**Final Model**

#Add the final model HERE#

As the model summary statistics suggested, Black, treatment, age and the interaction terms between age and treatment are four significant variables in the predictive model, using a threshold of 0.1. To get a general sense of how much better the fitted model is to the null model, we compare the difference between null deviance and residual deviance. In this model, the residual deviance is 666.50 which is significantly differ from the null deviance 643.51, thus suggesting at lease one of the model coefficients is sufficiently predicting the possibility of getting non-zero wage.

Associationa suggested by the final model:
 -- keep other variables the constant, compared to people in the treatment group, the average odds possibility of getting paid jobs for those without job training decrease by 72% with a 95% range of []
 
 -- There's a strong association between age and the possibility of positive wage. Keep other variables the constant, one unit increase in age will result in a 4% decrease in the average odds possibility of getting non-zero wage.
 
 -- The effect of treatment on the non-zero wage rate does changes according to ages. Compared to people without training, a worker get 6% more odds possibility of getting positive income for one unit increase in age and the job training.

```{r, echo = FALSE}
final <- glm(inc78_factor~black+treat*age,family = binomial,data = income)
summary(final)
exp(final$coefficients)
```

## Model Accessment

For the model assessment of existed model, we calculate the raw (response) residuals for fitted logistic regression and plot average residual versus average predicted probability (or average predictor value) for each bin to explore abnormal patterns. According to the binned residual plot, all the points fall between the red lines which represent a band expected 95% of the observations. Therefore, we confirmed the model assumption is not violated. 

Moreover, cook's distance is used to examine any potential outliers in the model. [........]

Finally, variance inflation factors was used to confirm that no multicolinearity existed in the chosen model. As all the VIFs were confirmed to be below 5 except the interaction terms, the model was finalized and used for inference.

```{r binned residual, echo = FALSE}
residFinal <- residuals(final,"resp")
binnedplot(x=fitted(final),y=residFinal,xlab="Pred. probabilities",col.int="red4",ylab="Avg. residuals",main="Binned residual plot",col.pts="navy") # 92% within SE band
```

```{r}
# missing a outlier check
```

```{r collinearity, echo = FALSE}
vif(final)
```

## Model Validation

```{r, echo = FALSE}
Conf_mat <- confusionMatrix(as.factor(ifelse(fitted(final) >= 0.5, "1","0")),
                            as.factor(income$inc78_factor),positive = "1")
Conf_mat$table
Conf_mat$overall["Accuracy"];
Conf_mat$byClass[c("Sensitivity","Specificity")] #True positive rate and True negative rate

Conf_mat <- confusionMatrix(as.factor(ifelse(fitted(final) >= mean(income$inc78), "1","0")),
                            as.factor(income$inc78_factor),positive = "1")
Conf_mat$table
Conf_mat$overall["Accuracy"];
Conf_mat$byClass[c("Sensitivity","Specificity")] #True positive rate and True negative rate

roc(income$inc78_factor,fitted(final),plot=T,print.thres="best",print.auc=T,legacy.axes=T,col="red3")
roc(income$inc78_factor,fitted(raw),plot=T,legacy.axes=T,add=T,col="blue3")
legend('bottomright', c('final','raw'),lty=c(1,1),
       lwd=c(2,2),col=c('red3','blue3'))
```

## Conclusion and Limitation

[..........]

## Appendix and Reference
[1] Lalonde, R. J. (1986), Evaluating the econometric evaluations of training programs with experimental data, The American Economic Review, 76, 604 - 620